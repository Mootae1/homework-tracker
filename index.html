<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Homework Tracker ‚Äî ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --card:#07102840; --glass: rgba(255,255,255,0.04);
    --accent:#7c3aed; --muted:#94a3b8; --ok:#22c55e; --warn:#eab308; --bad:#ef4444;
  }
  *{box-sizing:border-box;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{margin:0;min-height:100vh;background:
    radial-gradient(circle at top left,#071021,#020617);
    color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:20px;}
  .app{width:100%;max-width:1000px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
       border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.6);}
  header{Display:flex;align-items:center;justify-content:space-between;gap:12px;}
  h1{margin:0;color:var(--accent);font-weight:700}
  .clock{font-weight:600;color:var(--muted)}
  .summary{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--glass);padding:12px;border-radius:10px;min-width:160px}
  .controls{display:flex;gap:8px;align-items:center}
  /* layout */
  .main{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
  .box{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px}
  form input, form select, form textarea, button{width:100%;padding:10px;border-radius:8px;border:none;outline:none;background:rgba(255,255,255,0.03);color:inherit}
  textarea{min-height:80px;resize:vertical}
  ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
  li{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px}
  .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .badge{padding:6px 8px;border-radius:999px;font-weight:600}
  .green{background:rgba(34,197,94,0.12);color:var(--ok)}
  .yellow{background:rgba(234,179,8,0.08);color:var(--warn)}
  .red{background:rgba(239,68,68,0.08);color:var(--bad)}
  .small{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:8px}
  .btn{background:linear-gradient(90deg,var(--accent),#6366f1);color:white;padding:8px 12px;border-radius:8px;cursor:pointer;border:none;font-weight:600}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
  .login-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.6));backdrop-filter:blur(4px)}
  .login-card{width:380px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:12px}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
  @media (max-width:900px){.main{grid-template-columns:1fr;}.login-card{width:92%}}
</style>
</head>
<body>
<div class="app" id="app" aria-live="polite">
  <header>
    <div>
      <h1>Homework Tracker</h1>
      <div class="small">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô ‚Äî ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div>
    </div>
    <div class="controls">
      <div class="clock" id="clock">--:--:--</div>
      <button class="btn ghost" id="logoutBtn" style="display:none">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </header>

  <div class="summary" id="summary">
    <div class="card">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong id="totalCount">0</strong></div>
    <div class="card">‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà: <strong id="pendingCount">0</strong></div>
    <div class="card">‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: <strong id="soonCount">0</strong></div>
  </div>

  <div class="main">
    <div>
      <div class="box">
        <h3 style="margin-top:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>
        <input id="filter" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ä‡∏≤..." class="small" style="margin-bottom:10px">
        <ul id="taskList" aria-live="polite"></ul>
        <p id="emptyMsg" class="small" style="margin-top:10px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô üéâ</p>
      </div>
      <div class="box" style="margin-top:12px">
        <h3 style="margin-top:0">‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ</h3>
        <div class="small" id="summaryText">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
      </div>
    </div>

    <aside>
      <div class="box" id="adminPanel" style="display:none">
        <h3 style="margin-top:0">Admin: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</h3>
        <form id="taskForm">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
          <input id="taskName" required>
          <label>‡∏ß‡∏¥‡∏ä‡∏≤</label>
          <select id="subject" required>
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>
            <option>‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</option>
      <option>‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option>
      <option>‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option>
      <option>‡∏ä‡∏µ‡∏ß‡∏∞(‡∏ò‡∏ô‡∏≤‡∏ß‡∏∏‡∏ï)</option>
      <option>‡∏ä‡∏µ‡∏ß‡∏∞(‡∏Ç‡∏ô‡∏¥‡∏©‡∏ê‡∏≤)</option>
      <option>‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå</option>
      <option>‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</option>
      <option>‡πÄ‡∏Ñ‡∏°‡∏µ</option>
      <option>‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©(Elvin)</option>
      <option>‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©(‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô)</option>
      <option>‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©(‡∏≠‡∏≥‡∏ô‡∏≤‡∏à)</option>
      <option>‡∏ß‡∏¥‡∏®‡∏ß‡∏∞</option>
      <option>‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
      <option>‡πÄ‡∏†‡∏™‡∏±‡∏ä</option>
      <option>‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå</option>
      <option>‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
      <option>IS</option>
      <option>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
      <option>‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
          </select>
          <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
          <textarea id="details"></textarea>
          <label>‡∏•‡∏¥‡∏á‡∏Å‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <input id="link" type="url" placeholder="https://...">
          <label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
          <input id="deadline" type="datetime-local" required>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" type="submit">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
            <button class="btn ghost" type="button" id="clearForm">‡∏•‡πâ‡∏≤‡∏á</button>
          </div>
        </form>

        <div class="small" style="margin-top:10px;color:var(--muted)">
          ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ <strong>Apps Script URL</strong> ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ (‡∏ï‡πâ‡∏≠‡∏á Deploy ‡πÅ‡∏•‡πâ‡∏ß) ‡πÅ‡∏•‡∏∞ <strong>‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà SECRET_KEY</strong> ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå (‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
        </div>
      </div>

      <div class="box">
        <h3 style="margin-top:0">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <div class="small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <strong id="roleLabel">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</strong></div>
        <div style="margin-top:8px" id="loginHint">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
      </div>
    </aside>
  </div>

  <footer>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ Homework Tracker ‚Ä¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç SECRET_KEY ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</footer>
</div>

<!-- Login modal (client-side simple auth) -->
<div class="login-modal" id="loginModal" role="dialog" aria-modal="true">
  <div class="login-card">
    <h3 style="margin-top:0">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
    <input id="loginUser" placeholder="guest ‡∏´‡∏£‡∏∑‡∏≠ admin">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
    <input id="loginPass" type="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="loginBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <button class="btn ghost" id="demoBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô Guest</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡∏ù‡∏±‡πà‡∏á client ‚Äî ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å source ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Apps Script ‡∏ó‡∏≤‡∏á‡∏ù‡∏±‡πà‡∏á server</p>
  </div>
</div>

<script>
// === ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡πÅ‡∏Å‡πâ URL ‡πÅ‡∏•‡∏∞ SECRET_KEY ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ===
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxrupP7pN3IUUC2_YPf8tUP3aksKFczQQXI-jYb6t0yBJReBBDPLLWWoYl9x0eQ0JlO/exec";
const SECRET_KEY = "MEI"; 

// === ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ù‡∏±‡πà‡∏á client (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢) ===
const CLIENT_AUTH = {
  guest: "guest",      // username: guest, password: guest
  admin: "MEI"         // username: admin, password: MEI (‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏¢‡πà‡∏≤‡πÅ‡∏ä‡∏£‡πå)
};

// === ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ UI ===
const loginModal = document.getElementById('loginModal');
const loginBtn = document.getElementById('loginBtn');
const demoBtn = document.getElementById('demoBtn');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const roleLabel = document.getElementById('roleLabel');
const logoutBtn = document.getElementById('logoutBtn');

const taskListEl = document.getElementById('taskList');
const totalCountEl = document.getElementById('totalCount');
const pendingCountEl = document.getElementById('pendingCount');
const soonCountEl = document.getElementById('soonCount');
const summaryText = document.getElementById('summaryText');
const emptyMsg = document.getElementById('emptyMsg');
const adminPanel = document.getElementById('adminPanel');
const filterInput = document.getElementById('filter');
const clockEl = document.getElementById('clock');
const logout = document.getElementById('logoutBtn');

// estado
let role = null; // 'guest' | 'admin'
let tasksCache = [];

// === ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ===
function updateClock(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  clockEl.textContent = hh+':'+mm+':'+ss;
}
setInterval(updateClock,1000);
updateClock();

// === Auth (client-side simple) ===
function setRole(r){
  role = r;
  localStorage.setItem('hw_role', r);
  roleLabel.textContent = r ? (r==='admin' ? 'Admin' : 'Guest') : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô';
  loginModal.style.display = r ? 'none' : 'flex';
  adminPanel.style.display = r==='admin' ? 'block' : 'none';
  logout.style.display = r ? 'inline-flex' : 'none';
}
logout.addEventListener('click', ()=>{ localStorage.removeItem('hw_role'); setRole(null); });

// ‡πÇ‡∏´‡∏•‡∏î role ‡∏à‡∏≤‡∏Å localStorage
const saved = localStorage.getItem('hw_role');
if(saved){ setRole(saved); } else { setRole(null); }

// login
loginBtn.addEventListener('click', ()=>{
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();
  if(u==='guest' && p===CLIENT_AUTH.guest){ setRole('guest'); return; }
  if(u==='admin' && p===CLIENT_AUTH.admin){ setRole('admin'); return; }
  alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
});
demoBtn.addEventListener('click', ()=>{ loginUser.value='guest'; loginPass.value='guest'; loginBtn.click(); });

// === ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet (GET) ===
async function fetchTasks(){
  try{
    const res = await fetch(SCRIPT_URL);
    if(!res.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
    const data = await res.json();
    // normalize: ensure fields exist
    tasksCache = (data||[]).map((t, idx)=>({
      id: idx,
      name: t.name || t[0] || '',
      subject: t.subject || t[1] || '',
      details: t.details || t[2] || '',
      link: t.link || t[3] || '',
      deadline: t.deadline || t[4] || '',
      done: (t.done === true || String(t.done).toLowerCase()==='true') ? true : false
    }));
  }catch(err){
    console.error(err);
    tasksCache = [];
  }
}

// === ‡∏™‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (POST) ===
async function postTask(task){
  try{
    const body = {...task, key: SECRET_KEY};
    const res = await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok) throw new Error('POST failed');
    const txt = await res.text();
    return txt;
  }catch(e){
    console.error(e);
    throw e;
  }
}

// === Render tasks ===
function statusClass(diff){
  if(diff <= 0) return 'red';
  if(diff <= 48*3600*1000) return 'yellow';
  return 'green';
}

function formatCountdown(diff){
  if(diff <= 0) return '‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
  const d = Math.floor(diff/(1000*60*60*24));
  const h = Math.floor(diff/(1000*60*60)%24);
  const m = Math.floor(diff/(1000*60)%60);
  return `${d} ‡∏ß‡∏±‡∏ô ${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
}

async function render(){
  await fetchTasks();
  const filter = filterInput.value.trim().toLowerCase();
  taskListEl.innerHTML = '';
  let shown = 0;
  let total = tasksCache.length;
  let pending = 0;
  let soon = 0;

  const now = Date.now();
  tasksCache.sort((a,b)=> new Date(a.deadline) - new Date(b.deadline));

  tasksCache.forEach((task, idx)=>{
    if(filter && !task.subject.toLowerCase().includes(filter)) return;
    if(task.done) return;
    const diff = new Date(task.deadline) - now;
    const cls = statusClass(diff);
    if(diff > 0) pending++;
    if(diff > 0 && diff <= 48*3600*1000) soon++;
    const li = document.createElement('li');
    li.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">${escapeHtml(task.name)} <span class="small">(${escapeHtml(task.subject)})</span></div>
          <div class="small">${task.details ? escapeHtml(task.details) : ''}</div>
          ${task.link ? `<div class="small">üîó <a href="${escapeAttr(task.link)}" target="_blank">${escapeAttr(task.link)}</a></div>` : ''}
        </div>
        <div style="text-align:right">
          <div class="badge ${cls}">${cls==='red' ? '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤' : cls==='yellow' ? '‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö' : '‡∏õ‡∏Å‡∏ï‡∏¥'}</div>
          <div class="small" style="margin-top:6px">${new Date(task.deadline).toLocaleString()}</div>
        </div>
      </div>
      <div class="meta">
        <div class="small">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${formatCountdown(diff)}</div>
        <div class="actions">
          ${role==='admin' ? `<button class="btn ghost" data-idx="${idx}" onclick="markDone(${idx})">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>
          <button class="btn ghost" data-idx="${idx}" onclick="requestDelete(${idx})">‡∏•‡∏ö</button>` : ''}
        </div>
      </div>
    `;
    taskListEl.appendChild(li);
    shown++;
  });

  totalCountEl.textContent = total;
  pendingCountEl.textContent = pending;
  soonCountEl.textContent = soon;
  summaryText.textContent = `‡∏£‡∏ß‡∏° ${total} ‡∏á‡∏≤‡∏ô ‚Äî ‡∏Ñ‡πâ‡∏≤‡∏á ${pending} ‡∏á‡∏≤‡∏ô ‚Äî ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 48 ‡∏ä‡∏°. ${soon} ‡∏á‡∏≤‡∏ô`;
  emptyMsg.style.display = shown ? 'none' : 'block';
}

// === ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß / ‡∏•‡∏ö (‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î) ===
// NOTE: Apps Script ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ POST append ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô.
// ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏ö/mark-as-done ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô Apps Script (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á).
// ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script ‡∏î‡πâ‡∏ß‡∏¢ action ‡πÅ‡∏ï‡πà Apps Script ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢.
window.markDone = async function(idx){
  if(!confirm('‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß? (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô Sheet ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ Apps Script)')) return;
  const task = tasksCache[idx];
  // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á request action=done (Apps Script ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
  try{
    const body = { action: 'done', idx, key: SECRET_KEY, name: task.name, deadline: task.deadline };
    await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡πâ Apps Script ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏´‡∏≤‡∏Å Apps Script ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô Sheet');
    await render();
  }catch(e){
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ (‡∏î‡∏π console)');
  }
}

window.requestDelete = async function(idx){
  if(!confirm('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å Sheet? (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Apps Script ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á delete)')) return;
  const task = tasksCache[idx];
  try{
    const body = { action: 'delete', idx, key: SECRET_KEY, name: task.name };
    await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡πâ Apps Script ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏´‡∏≤‡∏Å Apps Script ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏à‡∏∞‡∏•‡∏ö‡∏á‡∏≤‡∏ô');
    await render();
  }catch(e){
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ (‡∏î‡∏π console)');
  }
}

// === ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô ===
document.getElementById('taskForm').addEventListener('submit', async e=>{
  e.preventDefault();
  if(role!=='admin'){ alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; }
  const t = {
    name: document.getElementById('taskName').value.trim(),
    subject: document.getElementById('subject').value.trim(),
    details: document.getElementById('details').value.trim(),
    link: document.getElementById('link').value.trim(),
    deadline: document.getElementById('deadline').value,
    done: false
  };
  if(!t.name || !t.subject || !t.deadline){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
  try{
    await postTask(t);
    alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ');
    e.target.reset();
    await render();
  }catch(err){
    alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏î‡∏π console)');
  }
});
document.getElementById('clearForm').addEventListener('click', ()=>{ document.getElementById('taskForm').reset(); });

// === filter debounce ===
let filterTimeout = null;
filterInput.addEventListener('input', ()=>{ clearTimeout(filterTimeout); filterTimeout = setTimeout(render, 300); });

// === escape helpers ===
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(s){ if(!s) return ''; return String(s).replace(/"/g,'%22'); }

// initial load
render();
setInterval(render, 60000);
</script>
</body>
</html>
